<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Auth å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #d32f2f;
      margin-bottom: 10px;
    }
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 30px;
    }
    .warning h2 {
      margin-top: 0;
      color: #856404;
    }
    .warning ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .warning li {
      margin: 5px 0;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    button {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      background: #b71c1c;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #d32f2f;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .result {
      margin-top: 30px;
      padding: 20px;
      border-radius: 4px;
      display: none;
    }
    .result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .result.warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }
    .info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      font-size: 13px;
    }
    .info h3 {
      margin-top: 0;
      font-size: 14px;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš ï¸ Supabase Auth å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</h1>
    
    <div class="warning">
      <h2>âš ï¸ è­¦å‘Š: ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</h2>
      <p><strong>ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€å¿…ãšä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:</strong></p>
      <ul>
        <li>âœ… <a href="/export-users.html" target="_blank">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰</a>ã‚’å–å¾—æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨</li>
        <li>âœ… å‰Šé™¤å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ç¢ºèªæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨</li>
        <li>âœ… ã“ã®æ“ä½œãŒæœ¬å½“ã«å¿…è¦ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨</li>
        <li>âœ… å‰Šé™¤å¾Œã€åŒæœŸå‡¦ç†ã‚’å†å®Ÿè¡Œã™ã‚‹äºˆå®šã§ã‚ã‚‹ã“ã¨</li>
      </ul>
    </div>

    <form id="deleteForm">
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="confirmBackup" required>
          <span>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ã‚’å–å¾—æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸ</span>
        </label>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="confirmDelete" required>
          <span>å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã‚’ç†è§£ã—ã€å®Ÿè¡Œã—ã¾ã™</span>
        </label>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="dryRun" checked>
          <span>ã¾ãšå‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã™ã‚‹ï¼ˆdryRunãƒ¢ãƒ¼ãƒ‰ï¼‰</span>
        </label>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
          dryRunãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å®Ÿéš›ã«ã¯å‰Šé™¤ã›ãšã«å‰Šé™¤å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
          æœ€åˆã®å®Ÿè¡Œæ™‚ã¯ã€ã“ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ONã®ã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚
        </p>
      </div>

      <button type="submit" id="deleteBtn">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤</button>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>å‡¦ç†ä¸­...</p>
    </div>

    <div class="result" id="result"></div>

    <div class="info">
      <h3>ä½¿ç”¨æ–¹æ³•</h3>
      <ol>
        <li><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—</strong>: ã¾ãš<a href="/export-users.html" target="_blank">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>ã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„</li>
        <li><strong>dryRunãƒ¢ãƒ¼ãƒ‰ã§ç¢ºèª</strong>: æœ€åˆã¯ã€Œå‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã™ã‚‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸã¾ã¾å®Ÿè¡Œã—ã€å‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
        <li><strong>å®Ÿéš›ã®å‰Šé™¤</strong>: å‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã—ãŸã‚‰ã€ã€Œå‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã™ã‚‹ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„</li>
      </ol>

      <h3 style="margin-top: 20px;">APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰</h3>
      <p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§APIã‚’ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™:</p>
      <code>
        curl -X POST https://your-domain.com/api/delete-all-users \<br>
        &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
        &nbsp;&nbsp;-d '{"confirm": true, "dryRun": false}'
      </code>
    </div>
  </div>

  <script>
    const form = document.getElementById('deleteForm');
    const confirmBackup = document.getElementById('confirmBackup');
    const confirmDelete = document.getElementById('confirmDelete');
    const dryRunCheckbox = document.getElementById('dryRun');
    const deleteBtn = document.getElementById('deleteBtn');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!confirmBackup.checked || !confirmDelete.checked) {
        alert('ã™ã¹ã¦ã®ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');
        return;
      }

      const dryRun = dryRunCheckbox.checked;

      // æœ€çµ‚ç¢ºèª
      if (!dryRun) {
        const finalConfirm = confirm(
          'âš ï¸ æœ€çµ‚ç¢ºèª\n\n' +
          'ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n' +
          'æœ¬å½“ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' +
          'OKã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚'
        );
        
        if (!finalConfirm) {
          return;
        }
      }

      // UIæ›´æ–°
      deleteBtn.disabled = true;
      loading.style.display = 'block';
      result.style.display = 'none';

      try {
        const response = await fetch('/api/delete-all-users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            confirm: true,
            dryRun: dryRun,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // çµæœã‚’è¡¨ç¤º
        loading.style.display = 'none';
        result.style.display = 'block';

        if (dryRun) {
          result.className = 'result warning';
          result.innerHTML = `
            <h3>ğŸ” å‰Šé™¤å¯¾è±¡ã®ç¢ºèªï¼ˆdryRunãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
            <p><strong>å‰Šé™¤å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.totalUsers}ä»¶</strong></p>
            <p>å®Ÿéš›ã«ã¯å‰Šé™¤ã—ã¦ã„ã¾ã›ã‚“ã€‚å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€ã€Œå‰Šé™¤å¯¾è±¡ã‚’ç¢ºèªã™ã‚‹ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            ${data.users ? `
              <details style="margin-top: 15px;">
                <summary style="cursor: pointer; font-weight: 600;">å‰Šé™¤å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                      <tr style="background: #f8f9fa;">
                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">kintoneãƒ¬ã‚³ãƒ¼ãƒ‰ID</th>
                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ä½œæˆæ—¥æ™‚</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${data.users.map(user => `
                        <tr>
                          <td style="padding: 8px; border: 1px solid #ddd;">${user.email || '(ãªã—)'}</td>
                          <td style="padding: 8px; border: 1px solid #ddd;">${user.kintone_record_id || '(ãªã—)'}</td>
                          <td style="padding: 8px; border: 1px solid #ddd;">${user.created_at ? new Date(user.created_at).toLocaleString('ja-JP') : '(ãªã—)'}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </details>
            ` : ''}
          `;
        } else {
          if (data.success) {
            result.className = 'result success';
            result.innerHTML = `
              <h3>âœ… å‰Šé™¤å®Œäº†</h3>
              <p><strong>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.deleted}ä»¶</strong></p>
              <p>${data.message}</p>
            `;
          } else {
            result.className = 'result warning';
            result.innerHTML = `
              <h3>âš ï¸ éƒ¨åˆ†çš„ãªæˆåŠŸ</h3>
              <p><strong>å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.deleted}ä»¶</strong></p>
              <p><strong>å‰Šé™¤ã«å¤±æ•—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${data.failed}ä»¶</strong></p>
              <p>${data.message}</p>
              ${data.failedUsers && data.failedUsers.length > 0 ? `
                <details style="margin-top: 15px;">
                  <summary style="cursor: pointer; font-weight: 600;">å‰Šé™¤ã«å¤±æ•—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>
                  <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                    <ul>
                      ${data.failedUsers.map(user => `<li>${user.email}: ${user.error}</li>`).join('')}
                    </ul>
                  </div>
                </details>
              ` : ''}
            `;
          }
        }
      } catch (error) {
        loading.style.display = 'none';
        result.style.display = 'block';
        result.className = 'result error';
        result.innerHTML = `
          <h3>âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <p>${error.message || 'å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}</p>
        `;
      } finally {
        deleteBtn.disabled = false;
      }
    });
  </script>
</body>
</html>

