# トラブルシューティングガイド

## kintone APIの制限について

### offsetの上限（10,000件）

kintone APIの`offset`パラメータには**10,000件の上限**があります。この制限を超えると、APIリクエストが正常に処理されなくなる可能性があります。

**症状:**
- offsetが10,000を超えるとエラーが発生する
- 52件しか取得されない（フィルタリング後のレコード数が少ない）

**解決策:**
- offsetが10,000を超える場合は、レコードIDベースの取得に自動的に切り替わります
- ログに `⚠️ offsetが10,000を超えるため、レコードIDベースの取得に切り替えます` と表示されます

### フィルタリング後のレコード数が少ない

kintoneから500件取得しても、フィルタリング後に52件しか残らない場合があります。

**原因:**
- `permissionGroup.groupName`の条件に一致するレコードが少ない
- kintoneから取得したレコードの多くが条件に一致しない

**確認方法:**
1. Vercelのログで以下を確認：
   ```
   [フィルタリング] 500件 → 52件 (条件に一致したレコード数)
   ```
2. kintoneアプリで、条件に一致するレコードが実際に存在するか確認

## 自動同期が停止している場合

### GitHub Actionsの実行状況を確認

1. **GitHubリポジトリにアクセス**
   - [https://github.com](https://github.com) にアクセス
   - リポジトリを選択

2. **Actionsタブを開く**
   - 左側のメニューから「**Actions**」を選択
   - 「**Sync kintone users to Supabase**」ワークフローを選択

3. **実行履歴を確認**
   - 最新の実行が成功しているか確認
   - エラーが発生している場合は、ログを確認

4. **手動実行で確認**
   - 「**Run workflow**」ボタンをクリック
   - 手動実行で動作を確認

### よくある原因

1. **GitHub Actionsの実行が失敗している**
   - エラーログを確認
   - 環境変数が正しく設定されているか確認

2. **Vercelのタイムアウト**
   - 処理時間が60秒を超えている
   - `stoppedReason: "timeout"` が表示される

3. **kintone APIのレート制限**
   - 1時間あたりのリクエスト数が上限を超えている
   - エラーログに `429 Too Many Requests` が表示される

## デバッグ方法

### 1. Vercelのログを確認

1. **Vercelダッシュボードにログイン**
   - [https://vercel.com](https://vercel.com) にアクセス
   - プロジェクトを選択

2. **ログを確認**
   - 左側のメニューから「**Logs**」を選択
   - `/api/sync-kintone-users` を選択
   - リアルタイムログを確認

### 2. Supabase Authで全ユーザーを確認

1. **APIエンドポイントにアクセス**
   ```
   https://your-domain.vercel.app/api/list-all-users
   ```

2. **ユーザー数を確認**
   - `total`: 全ユーザー数
   - `usersWithKintoneId`: kintoneレコードIDがあるユーザー数
   - `usersWithoutKintoneId`: kintoneレコードIDがないユーザー数

### 3. kintoneアプリでレコードを確認

1. **kintoneアプリにアクセス**
   - アプリID: 846（設定値に応じて変更）

2. **条件に一致するレコードを確認**
   - `permissionGroup.groupName`が「試験対策集中講座（養成）」または「合格パック単体（養成）」のレコードが存在するか確認

## エラーメッセージと対処法

### "kintone API エラー: 400 - Invalid request"

**原因:**
- クエリ構文が正しくない
- offsetが10,000を超えている

**対処法:**
- クエリ構文を確認
- offsetが10,000を超える場合は、レコードIDベースの取得に自動的に切り替わります

### "Supabase Adminクライアントが初期化されていません"

**原因:**
- 環境変数`SUPABASE_SERVICE_ROLE_KEY`が設定されていない

**対処法:**
- Vercelの環境変数を確認
- `.env.local`ファイルを確認（ローカル環境の場合）

### "FUNCTION_INVOCATION_TIMEOUT"

**原因:**
- Vercelの関数実行時間が60秒を超えている

**対処法:**
- `maxBatches`を減らす（例: 10 → 5）
- `batchSize`を減らす（例: 50 → 25）

## パフォーマンス最適化

### 1. バッチサイズの調整

- `batchSize`: 1回の処理件数（デフォルト: 50）
- `maxBatches`: 最大バッチ数（デフォルト: 10）
- タイムアウトが発生する場合は、これらの値を減らす

### 2. フィルタリングの最適化

- kintoneアプリで条件に一致するレコードが少ない場合、フィルタリング後のレコード数が少なくなります
- これは正常な動作です

### 3. レコードIDベースの取得

- offsetが10,000を超える場合は、レコードIDベースの取得に自動的に切り替わります
- これにより、大量のレコードを処理できます
