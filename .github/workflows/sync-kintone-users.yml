name: Sync kintone users to Supabase

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“ï¼‰
    # æ—¥æœ¬æ™‚é–“ã§ã¯æ¯æ™‚9åˆ†ï¼ˆUTC+9ï¼‰
    - cron: '0 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      processAll:
        description: 'å…¨ä»¶å‡¦ç†ã™ã‚‹ã‹ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      maxBatches:
        description: 'æœ€å¤§ãƒãƒƒãƒæ•°ï¼ˆå…¨ä»¶å‡¦ç†æ™‚ï¼‰'
        required: false
        default: '30'
        type: string
      batchSize:
        description: '1ãƒãƒƒãƒã‚ãŸã‚Šã®å‡¦ç†ä»¶æ•°'
        required: false
        default: '50'
        type: string
      deleteOrphanedUsers:
        description: 'å­¤ç«‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã‹ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
    
    steps:
      - name: Sync users from kintone to Supabase
        env:
          API_URL: ${{ secrets.API_URL || 'https://your-domain.com' }}
          PROCESS_ALL: ${{ inputs.processAll || 'true' }}
          MAX_BATCHES: ${{ inputs.maxBatches || '30' }}
          BATCH_SIZE: ${{ inputs.batchSize || '50' }}
          DELETE_ORPHANED: ${{ inputs.deleteOrphanedUsers || 'false' }}
        run: |
          echo "=========================================="
          echo "kintone â†’ Supabase ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸå‡¦ç†"
          echo "=========================================="
          echo "é–‹å§‹æ™‚åˆ»: $(date)"
          echo "API URL: $API_URL"
          echo ""
          
          # API URLãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®å ´åˆã¯è­¦å‘Š
          if [ "$API_URL" = "https://your-domain.com" ]; then
            echo "âš ï¸  è­¦å‘Š: API_URLãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ã™ã€‚GitHub Secretsã«API_URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
            echo ""
          fi
          
          # API URLã®æ¤œè¨¼
          if [ "$API_URL" = "https://your-domain.com" ] || [ -z "$API_URL" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: API_URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Secretsã«API_URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
            echo "è¨­å®šæ–¹æ³•: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo "Name: API_URL"
            echo "Value: ã‚¢ãƒ—ãƒªã®URLï¼ˆä¾‹: https://your-project.vercel.appï¼‰"
            exit 1
          fi
          
          # åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ
          echo "åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œä¸­..."
          echo "ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: $API_URL/api/sync-kintone-users"
          
          # curlã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿½è·¡ï¼ˆ-Lã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¾“ã†ï¼‰
          # -wã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æœ€çµ‚çš„ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–: batchSizeã‚’50ã«æ¸›ã‚‰ã™
          # å¯¾è±¡è€…ãŒ697åã®ãŸã‚ã€maxBatchesã‚’20ã«è¨­å®šï¼ˆ50 Ã— 20 = 1000ä»¶ã¾ã§å‡¦ç†å¯èƒ½ï¼‰
          # å‰Šé™¤å‡¦ç†ã¯åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿ï¼‰
          echo "1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ..."
          echo "   ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: processAll=$PROCESS_ALL, maxBatches=$MAX_BATCHES, batchSize=$BATCH_SIZE, deleteOrphanedUsers=$DELETE_ORPHANED"
          sync_response=$(curl -s -L -w "\n%{http_code}\n%{url_effective}" -X POST "$API_URL/api/sync-kintone-users" \
            -H "Content-Type: application/json" \
            -d "{
              \"batchSize\": $BATCH_SIZE,
              \"offset\": 0,
              \"emailFieldCode\": \"email\",
              \"query\": \"\",
              \"processAll\": $PROCESS_ALL,
              \"maxBatches\": $MAX_BATCHES,
              \"deleteOrphanedUsers\": $DELETE_ORPHANED
            }")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢
          sync_http_code=$(echo "$sync_response" | tail -n2 | head -n1)
          sync_final_url=$(echo "$sync_response" | tail -n1)
          sync_body=$(echo "$sync_response" | sed '$d' | sed '$d')
          
          echo ""
          echo "åŒæœŸå‡¦ç†ã®HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $sync_http_code"
          echo "æœ€çµ‚URL: $sync_final_url"
          echo "åŒæœŸå‡¦ç†ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
          if [ -n "$sync_body" ]; then
            echo "$sync_body" | jq '.' 2>/dev/null || echo "$sync_body"
          else
            echo "(ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ãŒç©ºã§ã™)"
          fi
          echo ""
          
          # åŒæœŸå‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ã€å‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆdeleteOrphanedUsersãŒfalseã®å ´åˆã®ã¿ï¼‰
          if [ -n "$sync_http_code" ] && [ "$sync_http_code" -eq 200 ] && [ "$DELETE_ORPHANED" != "true" ]; then
            echo "2. å‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œä¸­..."
            delete_response=$(curl -s -L -w "\n%{http_code}\n%{url_effective}" -X POST "$API_URL/api/sync-kintone-users" \
              -H "Content-Type: application/json" \
              -d "{
                \"batchSize\": $BATCH_SIZE,
                \"offset\": 0,
                \"emailFieldCode\": \"email\",
                \"query\": \"\",
                \"processAll\": false,
                \"deleteOrphanedUsers\": true
              }")
            
            delete_http_code=$(echo "$delete_response" | tail -n2 | head -n1)
            delete_final_url=$(echo "$delete_response" | tail -n1)
            delete_body=$(echo "$delete_response" | sed '$d' | sed '$d')
            
            echo "å‰Šé™¤å‡¦ç†ã®HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $delete_http_code"
            echo "æœ€çµ‚URL: $delete_final_url"
            echo "å‰Šé™¤å‡¦ç†ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
            if [ -n "$delete_body" ]; then
              echo "$delete_body" | jq '.' 2>/dev/null || echo "$delete_body"
            else
              echo "(ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ãŒç©ºã§ã™)"
            fi
            echo ""
            
            # å‰Šé™¤å‡¦ç†ãŒå¤±æ•—ã—ãŸå ´åˆã¯è­¦å‘Š
            if [ -z "$delete_http_code" ] || [ "$delete_http_code" -ne 200 ]; then
              echo "âš ï¸  è­¦å‘Š: å‰Šé™¤å‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $delete_http_codeï¼‰"
            fi
          fi
          
          # çµæœåˆ¤å®šã«ã¯åŒæœŸå‡¦ç†ã®çµæœã‚’ä½¿ç”¨
          http_code="$sync_http_code"
          final_url="$sync_final_url"
          body="$sync_body"
          
          echo ""
          echo "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
          echo "æœ€çµ‚URL: $final_url"
          echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹:"
          if [ -n "$body" ]; then
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "(ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ãŒç©ºã§ã™)"
          fi
          echo ""
          
          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          if [ -z "$http_code" ] || [ "$http_code" -ne 200 ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ $http_code"
            if [ -n "$body" ]; then
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
            fi
            echo ""
            echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            echo "  API_URL: $API_URL"
            echo "  ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: $API_URL/api/sync-kintone-users"
            echo "  æœ€çµ‚URL: $final_url"
            if [ "$http_code" = "302" ] || [ "$http_code" = "301" ]; then
              echo ""
              echo "âš ï¸  ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚"
              echo "   API_URLãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
              echo "   è¨­å®šæ–¹æ³•: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            fi
            exit 1
          fi
          
          # çµæœã‚’ç¢ºèª
          success=$(echo "$body" | jq -r '.success // false' 2>/dev/null)
          if [ "$success" != "true" ]; then
            echo "âŒ è­¦å‘Š: åŒæœŸå‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
            
            # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            error_msg=$(echo "$body" | jq -r '.error // "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"' 2>/dev/null)
            if [ -n "$error_msg" ] && [ "$error_msg" != "null" ]; then
              echo ""
              echo "ã‚¨ãƒ©ãƒ¼è©³ç´°: $error_msg"
            fi
            exit 1
          fi
          
          # çµæœã‚’è¡¨ç¤º
          processed=$(echo "$body" | jq -r '.processed // .totalProcessed // 0' 2>/dev/null)
          created=$(echo "$body" | jq -r '.created // .totalCreated // 0' 2>/dev/null)
          skipped=$(echo "$body" | jq -r '.skipped // .totalSkipped // 0' 2>/dev/null)
          failed=$(echo "$body" | jq -r '.failed // .totalFailed // 0' 2>/dev/null)
          deleted=$(echo "$body" | jq -r '.deletedCount // 0' 2>/dev/null)
          
          # offsetç¯„å›²ã‚’å–å¾—
          offsetStart=$(echo "$body" | jq -r '.offsetRange.start // "N/A"' 2>/dev/null)
          offsetEnd=$(echo "$body" | jq -r '.offsetRange.end // "N/A"' 2>/dev/null)
          offsetProcessed=$(echo "$body" | jq -r '.offsetRange.processed // "N/A"' 2>/dev/null)
          offsetDescription=$(echo "$body" | jq -r '.offsetRange.description // ""' 2>/dev/null)
          nextOffset=$(echo "$body" | jq -r '.nextOffset // "N/A"' 2>/dev/null)
          stoppedEarly=$(echo "$body" | jq -r '.stoppedEarly // false' 2>/dev/null)
          
          echo "âœ… å‡¦ç†çµæœ:"
          echo "  å‡¦ç†ä»¶æ•°: $processed"
          echo "  ä½œæˆ: $created"
          echo "  ã‚¹ã‚­ãƒƒãƒ—: $skipped"
          echo "  å¤±æ•—: $failed"
          if [ "$deleted" != "0" ] && [ -n "$deleted" ]; then
            echo "  å‰Šé™¤: $deleted"
          fi
          echo ""
          echo "ğŸ“Š å‡¦ç†ã—ãŸoffsetç¯„å›²ï¼ˆkintoneã®å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸­ã®ä½ç½®ï¼‰:"
          if [ "$offsetStart" != "N/A" ] && [ "$offsetEnd" != "N/A" ] && [ "$offsetStart" != "null" ] && [ "$offsetEnd" != "null" ]; then
            echo "  é–‹å§‹offset: $offsetStart"
            echo "  çµ‚äº†offset: $offsetEnd"
            if [ "$offsetProcessed" != "N/A" ] && [ "$offsetProcessed" != "null" ]; then
              echo "  å‡¦ç†ç¯„å›²: $offsetProcessedä»¶ã®kintoneãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª"
            fi
            if [ -n "$offsetDescription" ] && [ "$offsetDescription" != "null" ]; then
              echo "  $offsetDescription"
            fi
          else
            echo "  offsetç¯„å›²ã®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
          fi
          echo "  æ¬¡å›å®Ÿè¡Œæ™‚ã®offset: $nextOffset"
          if [ "$stoppedEarly" = "true" ]; then
            echo "  âš ï¸ å‡¦ç†ãŒé€”ä¸­ã§ä¸­æ–­ã•ã‚Œã¾ã—ãŸï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯maxBatchesã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
            echo "  â†’ æ¬¡å›ã¯offset=$nextOffsetã‹ã‚‰ç¶šãã‚’å‡¦ç†ã—ã¾ã™"
          elif [ "$nextOffset" = "0" ] || [ "$nextOffset" = "0" ]; then
            echo "  âœ… å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†å®Œäº†ã®ãŸã‚ã€æ¬¡å›ã¯offset=0ã‹ã‚‰é–‹å§‹ã—ã¾ã™ï¼ˆæ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºï¼‰"
          fi
          echo ""
          echo "å®Œäº†æ™‚åˆ»: $(date)"
          echo "=========================================="
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "åŒæœŸå‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          # å¿…è¦ã«å¿œã˜ã¦ã€Slackã‚„ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’è¿½åŠ ã§ãã¾ã™

