# 同期処理のデバッグガイド

## 手動実行でユーザー数が増えない場合の確認方法

### 1. GitHub Actionsの実行ログを確認

手動実行後、以下の情報を確認してください：

#### 確認すべきポイント

1. **処理件数（processed）**
   - `processed: X` - kintoneから取得したレコード数
   - 0の場合は、kintoneからレコードが取得できていない

2. **作成件数（created）**
   - `created: X` - 新規作成したユーザー数
   - 0の場合は、既にすべてのユーザーが存在している可能性

3. **スキップ件数（skipped）**
   - `skipped: X` - スキップしたレコード数
   - 既存ユーザーはスキップされます

4. **フィルタリング結果**
   - `フィルタリング結果: X件 → Y件` - 条件に一致したレコード数
   - 0件の場合は、条件に一致するレコードがない

### 2. よくある原因と対処法

#### 原因1: 条件に一致するレコードがない

**症状**:
- `processed: 0`
- `フィルタリング結果: X件 → 0件`
- `条件に一致するレコードがありません`

**確認方法**:
1. kintoneアプリでレコードを確認
2. `permissionGroup`テーブル型フィールドが存在するか確認
3. `groupName`フィールドに以下のいずれかが含まれているか確認：
   - `試験対策集中講座（養成）`
   - `合格パック単体（養成）`

**対処法**:
- kintoneのレコードを確認し、条件に一致するレコードが存在するか確認
- `groupName`の値が完全一致しているか確認（スペースや全角/半角に注意）

#### 原因2: 既にすべてのユーザーがSupabaseに存在している

**症状**:
- `processed: X`（0より大きい）
- `created: 0`
- `skipped: X`（processedと同じ数）

**確認方法**:
1. Supabaseダッシュボードでユーザー一覧を確認
2. kintoneのレコードのメールアドレスと比較

**対処法**:
- これは正常な動作です
- 新規レコードをkintoneに追加すると、次回の実行で作成されます

#### 原因3: メールアドレスが無効

**症状**:
- `processed: X`
- `created: 0`
- `有効なメールアドレスが見つかりませんでした`

**確認方法**:
1. kintoneのレコードでメールアドレスフィールドを確認
2. メールアドレスの形式が正しいか確認

**対処法**:
- kintoneのレコードでメールアドレスを修正

#### 原因4: レコードIDが取得できていない

**症状**:
- `レコードIDが取得できませんでした`
- ログにレコードIDが表示されない

**確認方法**:
1. kintone APIのレスポンスを確認
2. `$id`フィールドが存在するか確認

**対処法**:
- kintone APIのレスポンス形式を確認
- レコードIDが正しく取得できているか確認

### 3. デバッグ用のログ確認

GitHub Actionsの実行ログで、以下のログを確認してください：

```
処理中: email=xxx@example.com, recordId=123
kintoneレコードID 123 で既存ユーザーを発見: xxx@example.com
新規ユーザーとして作成: xxx@example.com (レコードID: 123)
```

これらのログから、各レコードがどのように処理されているか確認できます。

### 4. テスト用のレコード追加

新規ユーザーが作成されるか確認するため、以下の条件を満たすテストレコードをkintoneに追加してください：

1. `permissionGroup`テーブル型フィールドが存在する
2. `groupName`フィールドに「試験対策集中講座（養成）」または「合格パック単体（養成）」が含まれている
3. メールアドレスフィールドに有効なメールアドレスが設定されている
4. そのメールアドレスがSupabaseに存在しない

### 5. 手動テスト

APIエンドポイントを直接呼び出してテスト：

```bash
curl -X POST https://your-domain.com/api/sync-kintone-users \
  -H "Content-Type: application/json" \
  -d '{
    "batchSize": 10,
    "offset": 0,
    "emailFieldCode": "email",
    "query": "",
    "processAll": false
  }'
```

レスポンスで`created`の値を確認してください。


